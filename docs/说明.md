## 1. 测试之前

执行以下命令开启音频:

```shell
amixer -c 0 cset numid=50 1
amixer -c 0 cset numid=50 1
amixer -c 0 cset numid=46 1
amixer cset numid=3 60000 60000
```



录音、播音命令:

```shell
arecord -v --format=cd --device=plughw:0,1 test.wav

aplay -t raw -c 2 -f S16_LE -r 44100 output.pcm --device=plughw:0,0

arecord -v --format=cd --device=plughw:0,1 test.wav
aplay -v --format=cd --device=plughw:0,0 test.wav

arecord -v --format=cd --device=default test.wav
aplay -v --format=cd --device=default test.wav
```

## 2. 项目改动总结 (2025年10月25日)

### 2.1 音频系统修复
- **问题**: sound_app 出现 ALSA 插件缺失错误，导致 PCM 设备打开失败和段错误
- **解决方案**: 安装 `libasound2-plugins` 包，提供音频格式转换支持
- **影响**: sound_app 现在可以正常录音和播放音频

### 2.2 服务器配置外部化
- **问题**: 服务器端点硬编码在代码中，不便于配置
- **解决方案**: 
  - 创建 `conf/server.json` 配置文件
  - 在 `control_center.cpp` 中添加 `read_server_config()` 函数
  - 支持动态读取 hostname、port、path、ota_url 和 use_tls 参数
- **文件改动**:
  - 新增: `conf/server.json`
  - 新增: `conf/README.md`
  - 修改: `control_center/control_center.cpp`

### 2.3 WebSocket TLS 支持
- **问题**: 连接本地服务器时出现 TLS 握手失败
- **解决方案**: 
  - 在配置中添加 `use_tls` 标志
  - 重构 `websocket_client.cpp`，使用模板支持动态 TLS/非TLS 连接
  - 根据配置选择 `tls_client` 或 `plain_client`
- **文件改动**:
  - 修改: `control_center/websocket_client.h`
  - 修改: `control_center/websocket_client.cpp`

### 2.4 构建系统优化
- **问题**: 编译速度慢，缺乏并行处理
- **解决方案**:
  - 添加 `JOBS` 检测和并行编译支持
  - 创建 `build.sh` 脚本
  - 在所有 Makefile 中添加 `parallel` 和 `fast` 目标
- **文件改动**:
  - 修改: `sound_app/Makefile`
  - 新增: `build.sh`

### 2.5 CMake 构建系统迁移
- **问题**: 各模块使用不同的构建系统，维护困难
- **解决方案**:
  - 为所有模块创建 CMakeLists.txt 文件
  - 支持可选依赖 (ALSA、Opus、SpeexDSP、Boost、OpenSSL、CURL、Threads、SDL2、Libdrm、FreeType)
  - 根目录 CMakeLists.txt 统一管理所有子模块
- **文件改动**:
  - 新增: `CMakeLists.txt` (根目录)
  - 新增: `control_center/CMakeLists.txt`
  - 新增: `sound_app/CMakeLists.txt`
  - 修改: `gui/CMakeLists.txt`

### 2.6 LVGL FreeType 支持启用
- **问题**: GUI 无法使用 TrueType 字体渲染
- **解决方案**:
  - 在 `lv_conf.h` 中设置 `LV_USE_FREETYPE 1`
  - 添加 FreeType 头文件路径和库链接
  - 添加 PNG 库支持
  - 包含 lv_100ask_xz_ai 源文件
  - 添加 C++ 编译支持
  - 修复 ThorVG C++ 编译问题
- **文件改动**:
  - 修改: `gui/lv_conf.h`
  - 修改: `gui/Makefile`
  - 修改: `gui/lvgl/src/libs/thorvg/tvgLottieProperty.h`

### 2.7 编译问题修复
- **FreeType 头文件缺失**: 添加 `-I/usr/include/freetype2` 到 CFLAGS
- **库链接缺失**: 添加 `-lfreetype -lpng -lpthread` 到 LDFLAGS
- **C++ 支持缺失**: 添加 CXX/CXXFLAGS 变量和 C++ 编译规则
- **ThorVG 赋值操作符错误**: 将花括号初始化替换为显式成员赋值
- **源文件缺失**: 包含 lv_100ask_xz_ai.mk 文件

### 2.8 构建和运行说明

#### 传统 Makefile 构建:
```bash
# 构建所有模块
cd control_center && make -j4
cd ../sound_app && make -j4  
cd ../gui && make -j4

# 或使用并行构建
make parallel  # 使用 JOBS 变量
make fast      # 强制 4 线程
```

#### CMake 构建:
```bash
# 创建构建目录
mkdir build && cd build

# 配置和构建
cmake ..
cmake --build . -j4

# 运行程序
./control_center/control_center
./sound_app/sound_app
./gui/main
```

#### 配置文件:
- 服务器配置: `conf/server.json`
- 本地测试时设置 `use_tls: false`

### 2.9 编译加速 (ccache)
- **安装**: `sudo apt install ccache`
- **配置**: PATH 已自动设置为 `/usr/lib/ccache:$PATH`
- **缓存大小**: 2.0 GB (可通过 `ccache -M <size>` 修改)
- **查看统计**: `ccache -s`
- **清理缓存**: `ccache -C`
- **性能提升**: 实测编译时间从 1分40秒 加速至 8秒 (12倍提升，缓存命中率45.45%)
- **优势**: 大幅加速重复编译，特别适合频繁修改代码的开发环境

### 2.10 已知问题和注意事项
- 确保系统已安装: `libasound2-plugins`, `libfreetype6-dev`, `libpng-dev`
- FreeType 需要头文件路径: `/usr/include/freetype2`
- 本地开发时使用非TLS WebSocket连接
- GUI 需要 C++11 支持编译 ThorVG
- 音频设备可能需要手动配置音量和路由

---

*最后更新: 2025年10月25日*

